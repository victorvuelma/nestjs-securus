# Migration `20200904012914-create-vehicle-documents`

This migration has been generated by Victor Vuelma at 9/3/2020, 10:29:14 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."VehcileDocumentType" AS ENUM ('RENAVAN')

ALTER TABLE "public"."CustomerDocuments" DROP CONSTRAINT "CustomerDocuments_customerId_fkey"

ALTER TABLE "public"."VehicleModel" DROP CONSTRAINT "VehicleModel_manufacturerId_fkey"

CREATE TABLE "public"."CustomerDocument" (
"id" SERIAL,
"type" "DocumentType"  NOT NULL ,
"value" text   NOT NULL ,
"customerId" integer   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."VehicleManufacturer" (
"id" SERIAL,
"name" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CustomerVehicle" (
"id" SERIAL,
"sign" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   ,
"variationId" integer   NOT NULL ,
"customerId" integer   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CustomerVehicleDocument" (
"id" SERIAL,
"type" "VehcileDocumentType"  NOT NULL ,
"value" text   NOT NULL ,
"vehicleId" integer   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "CustomerDocument.type_customerId_unique" ON "public"."CustomerDocument"("type", "customerId")

CREATE UNIQUE INDEX "CustomerVehicleDocument.type_vehicleId_unique" ON "public"."CustomerVehicleDocument"("type", "vehicleId")

ALTER TABLE "public"."CustomerDocument" ADD FOREIGN KEY ("customerId")REFERENCES "public"."Customer"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CustomerVehicle" ADD FOREIGN KEY ("variationId")REFERENCES "public"."VehicleVariation"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CustomerVehicle" ADD FOREIGN KEY ("customerId")REFERENCES "public"."Customer"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CustomerVehicleDocument" ADD FOREIGN KEY ("vehicleId")REFERENCES "public"."CustomerVehicle"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."VehicleModel" ADD FOREIGN KEY ("manufacturerId")REFERENCES "public"."VehicleManufacturer"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."CustomerDocuments"

DROP TABLE "public"."VechicleManufacturer"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200904011119-create-vehicle-structure..20200904012914-create-vehicle-documents
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -17,8 +17,12 @@
   RG
   CNH
 }
+enum VehcileDocumentType {
+  RENAVAN
+}
+
 model Customer {
   id                 Int                  @default(autoincrement()) @id
   cpf                String               @unique
   email              String               @unique
@@ -30,12 +34,13 @@
   phone              String?           
   cellPhone          String?           
   createdAt          DateTime             @default(now())
   updatedAt          DateTime?            @updatedAt
-  documents          CustomerDocuments[]
+  documents          CustomerDocument[]
+  vehicles           CustomerVehicle[]
 }
-model CustomerDocuments {
+model CustomerDocument {
   id                 Int                  @default(autoincrement()) @id
   type               DocumentType
   value              String
   customer           Customer             @relation(fields: [customerId], references: [id])
@@ -45,9 +50,9 @@
   @@unique([type, customerId])
 }
-model VechicleManufacturer {
+model VehicleManufacturer {
   id                 Int                  @default(autoincrement()) @id
   name               String
   createdAt          DateTime             @default(now())
   updatedAt          DateTime?            @updatedAt
@@ -58,9 +63,9 @@
   name               String
   year               Int
   createdAt          DateTime             @default(now())
   updatedAt          DateTime?            @updatedAt
-  manufacturer       VechicleManufacturer @relation(fields: [manufacturerId], references: [id])
+  manufacturer       VehicleManufacturer  @relation(fields: [manufacturerId], references: [id])
   manufacturerId     Int
   @@unique([name, year])
 }
@@ -73,8 +78,32 @@
   model              VehicleModel         @relation(fields: [modelId], references: [id])
   modelId            Int
 }
+model CustomerVehicle {
+  id                 Int                  @default(autoincrement()) @id
+  sign               String
+  createdAt          DateTime             @default(now())
+  updatedAt          DateTime?            @updatedAt
+  variation          VehicleVariation     @relation(fields: [variationId], references: [id])
+  variationId        Int
+  customer           Customer             @relation(fields: [customerId], references: [id])
+  customerId         Int
+}
+
+
+model CustomerVehicleDocument {
+  id                 Int                  @default(autoincrement()) @id
+  type               VehcileDocumentType
+  value              String
+  vehicle           CustomerVehicle      @relation(fields: [vehicleId], references: [id])
+  vehicleId          Int
+  createdAt          DateTime             @default(now())
+  updatedAt          DateTime?            @updatedAt
+
+  @@unique([type, vehicleId])
+}
+
 model User {
   id                 Int                  @default(autoincrement()) @id
   cpf                String               @unique
   email              String               @unique
```


